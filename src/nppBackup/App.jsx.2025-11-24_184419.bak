import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, collection, addDoc, query, orderBy, limit, 
  onSnapshot, doc, updateDoc, setDoc, getDoc, serverTimestamp, 
  runTransaction, arrayUnion, arrayRemove 
} from 'firebase/firestore';
import { 
  getAuth, onAuthStateChanged, signInWithCustomToken,
  signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInAnonymously
} from 'firebase/auth';
import { 
  Trophy, Gift, Activity, MessageSquare, 
  LogOut, UserPlus, Heart, Zap, Search, CheckCircle, Target, Sparkles,
  Briefcase, Flame, CheckSquare, XCircle, ShoppingBag, Crown, Camera, Lock
} from 'lucide-react';

// --- CONFIGURATION START ---

// 1. Firebase Configuration
const firebaseConfig = {
  apiKey: "AIzaSyAnjuK_F8ZO3WqTfCEeXEF5J84CG8Irjq4",
  authDomain: "yum-donut-school.firebaseapp.com",
  projectId: "yum-donut-school",
  storageBucket: "yum-donut-school.firebasestorage.app",
  messagingSenderId: "910400935670",
  appId: "1:910400935670:web:8f196e7da498d67ca17ed7"
};

// 2. School Roster
const SCHOOL_ROSTER = [
  "Mr Rayner",
  "Jacey",
  "Marina",
  "Amaia",
  "Charlotte",
  "Dewindi",
  "Alison",
  "Hunter",
  "Katie",
  "Isla",
  "Chenuthi",
  "Lily",
  "Alice",
  "Amelia",
  "Mackenzie",
  "Kanin",
  "Faith",
  "Olivia",
  "Seoyeon",
  "Lara",
  "Armani",
  "Ashley",
  "Tobin",
  "Isaac"
];

const DAILY_LIMIT = 5;
const GOAL_TARGET = 50; 
const EMOJI = "ðŸ©";
const APP_ID = 'yum-donut-school'; 

// 3. Shop Inventory
const SHOP_ITEMS = [
    { id: 'snack_2', name: 'Double Snack Attack', cost: 15, icon: 'ðŸ«', desc: 'Buy a second snack from the box.', type: 'physical' },
    { id: 'vip_schedule', name: 'VIP Schedule Bump', cost: 25, icon: 'ðŸ“…', desc: "Bump your show to the top of the 'let's work on it' list.", type: 'physical' },
    { id: 'comfy_chair', name: 'Comfy Chair Rental', cost: 30, icon: 'ðŸª‘', desc: 'Rent the good chair for a week.', type: 'physical' },
    { id: 'rainbow_name', name: 'Rainbow Name', cost: 60, icon: 'ðŸŒˆ', desc: 'Your name glows on the leaderboard!', type: 'digital' },
    { id: 'gold_pass', name: 'The GOLD Pass', cost: 100, icon: 'ðŸŽ«', desc: 'A physical, laminated Gold VIP Lanyard.', type: 'physical' },
    { id: 'name_camera', name: 'Name a Camera', cost: 500, icon: 'ðŸŽ¥', desc: 'Permanently name a DJI or Sony camera!', type: 'physical' },
];

// --- CONFIGURATION END ---

// --- Firebase Init ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// --- Helpers ---

const triggerConfetti = () => {
  const count = 40;
  for(let i=0; i<count; i++) {
    const el = document.createElement('div');
    el.innerText = EMOJI;
    el.style.position = 'fixed';
    el.style.left = Math.random() * 100 + 'vw';
    el.style.top = Math.random() * 100 + 'vh';
    el.style.fontSize = (Math.random() * 20 + 10) + 'px';
    el.style.pointerEvents = 'none';
    el.style.zIndex = '9999';
    el.style.transition = 'transform 1s ease-out, opacity 1s ease-out';
    document.body.appendChild(el);

    const angle = Math.random() * Math.PI * 2;
    const velocity = Math.random() * 200 + 50;
    const tx = Math.cos(angle) * velocity;
    const ty = Math.sin(angle) * velocity;

    requestAnimationFrame(() => {
      el.style.transform = `translate(${tx}px, ${ty}px) rotate(${Math.random()*360}deg)`;
      el.style.opacity = '0';
    });

    setTimeout(() => el.remove(), 1000);
  }
};

// --- Components ---

const Card = ({ children, className = "" }) => (
  <div className={`bg-white rounded-xl shadow-sm border border-slate-100 p-4 ${className}`}>
    {children}
  </div>
);

const Button = ({ onClick, disabled, children, variant = "primary", className = "" }) => {
  const base = "px-4 py-2 rounded-lg font-medium transition-all duration-200 flex items-center justify-center gap-2 active:scale-95";
  const styles = {
    primary: "bg-pink-500 hover:bg-pink-600 text-white shadow-lg shadow-pink-200 disabled:bg-pink-300 disabled:shadow-none",
    secondary: "bg-slate-100 hover:bg-slate-200 text-slate-700 disabled:bg-slate-50",
    outline: "border-2 border-slate-200 hover:border-pink-500 hover:text-pink-500 text-slate-600",
    success: "bg-green-500 hover:bg-green-600 text-white shadow-lg shadow-green-200 disabled:bg-green-300",
    danger: "bg-red-50 hover:bg-red-100 text-red-600 border border-red-200"
  };
  return (
    <button onClick={onClick} disabled={disabled} className={`${base} ${styles[variant]} ${className}`}>
      {children}
    </button>
  );
};

// --- Main Application ---

export default function YumDonutApp() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [view, setView] = useState('give'); 
  
  // Data State
  const [users, setUsers] = useState([]);
  const [transactions, setTransactions] = useState([]);
  const [bounties, setBounties] = useState([]); 
  const [goalData, setGoalData] = useState({ current: 0, contributors: {} });
  const [myProfile, setMyProfile] = useState(null);
  const [notification, setNotification] = useState(null);

  // Auth & Profile Listener
  useEffect(() => {
    const initAuth = async () => {
        if (!auth.currentUser) {
            try {
                await signInAnonymously(auth);
            } catch (e) {
                console.warn("Guest login skipped:", e.code);
            }
        }
    }
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
      setUser(currentUser);
      if (currentUser) {
        const userRef = doc(db, 'artifacts', APP_ID, 'users', currentUser.uid, 'profile', 'data');
        const unsubProfile = onSnapshot(userRef, (docSnap) => {
          if (docSnap.exists()) {
            setMyProfile(docSnap.data());
          } else {
            setMyProfile(null); 
          }
          setLoading(false);
        }, (error) => {
            console.error("Profile snapshot error", error);
            setLoading(false);
        });
        return () => unsubProfile();
      } else {
        setLoading(false);
      }
    });
    return () => unsubscribe();
  }, []);

  // Global Listeners
  useEffect(() => {
    if (!user) {
        setUsers([]);
        setTransactions([]);
        setBounties([]);
        return;
    }

    const usersQuery = query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'users'));
    const unsubUsers = onSnapshot(usersQuery, (snapshot) => {
      const usersList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setUsers(usersList);
    }, (e) => console.error("Users error", e));

    const feedQuery = query(
      collection(db, 'artifacts', APP_ID, 'public', 'data', 'transactions'), 
      orderBy('timestamp', 'desc'), 
      limit(25)
    );
    const unsubFeed = onSnapshot(feedQuery, (snapshot) => {
      const feedList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      setTransactions(feedList);
    }, (e) => console.error("Feed error", e));

    const goalRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'goals', 'frosted-friday');
    const unsubGoal = onSnapshot(goalRef, (docSnap) => {
        if (docSnap.exists()) {
            setGoalData(docSnap.data());
        } else {
            setDoc(goalRef, { current: 0, contributors: {} });
        }
    }, (e) => console.error("Goal error", e));

    const bountiesQuery = query(collection(db, 'artifacts', APP_ID, 'public', 'data', 'bounties'), orderBy('createdAt', 'desc'));
    const unsubBounties = onSnapshot(bountiesQuery, (snapshot) => {
        const bList = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        setBounties(bList);
    }, (e) => console.error("Bounties error", e));

    return () => { unsubUsers(); unsubFeed(); unsubGoal(); unsubBounties(); };
  }, [user]);

  // --- AUTO-SYNC WALLET (Fix for Amelia) ---
  // This effect checks if the Public balance (truth) differs from Private balance (wallet).
  // If they differ, it updates the Private wallet to match.
  useEffect(() => {
    if (!user || !myProfile || users.length === 0) return;

    // Find my public record
    const publicProfile = users.find(u => u.name === myProfile.name);
    
    if (publicProfile) {
        const publicBalance = publicProfile.balance || 0;
        const privateBalance = myProfile.balance || 0;

        // If they don't match, sync Private -> Public
        // (Because Public is where gifts are received)
        if (publicBalance !== privateBalance) {
            console.log(`Syncing wallet for ${myProfile.name}: ${privateBalance} -> ${publicBalance}`);
            const userRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'profile', 'data');
            updateDoc(userRef, { balance: publicBalance }).catch(console.error);
        }
    }
  }, [user, myProfile, users]);


  // Derived State
  const openBountyCount = bounties.filter(b => b.status === 'open').length;

  // --- Actions ---

  const handleLoginOrRegister = async (name, password) => {
    if (!name || !password) return;
    setLoading(true);
    
    const email = `${name.replace(/\s+/g, '').toLowerCase()}@yumdonut.school`;

    try {
        await signInWithEmailAndPassword(auth, email, password);
        showNotification(`Welcome back, ${name}!`);
    } catch (error) {
        if (error.code === 'auth/invalid-credential' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-email') {
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;
                
                // Check Public Data first to carry over balance
                const publicRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', name);
                const publicDoc = await getDoc(publicRef);
                
                let currentBalance = 0;
                let currentGiven = 0;
                let avatarColor = `hsl(${Math.random() * 360}, 70%, 50%)`;
                let rainbowName = false;

                if (publicDoc.exists()) {
                    const data = publicDoc.data();
                    // THIS IS THE KEY FIX: Load existing balance from Public
                    currentBalance = data.balance || 0;
                    currentGiven = data.lifetime_given || 0;
                    if (data.avatar_color) avatarColor = data.avatar_color;
                    if (data.rainbow_name) rainbowName = data.rainbow_name;
                }

                const initialPrivateData = {
                    name: name,
                    balance: currentBalance, // Use the found balance!
                    given_today: 0,
                    last_given_date: new Date().toDateString(),
                    avatar_color: avatarColor
                };

                await setDoc(doc(db, 'artifacts', APP_ID, 'users', uid, 'profile', 'data'), initialPrivateData);
                
                await setDoc(publicRef, {
                    name: name,
                    balance: currentBalance,
                    lifetime_given: currentGiven,
                    avatar_color: avatarColor,
                    rainbow_name: rainbowName,
                    claimed: true,
                    uid: uid 
                }, { merge: true });

                showNotification(`Account created for ${name}!`);

            } catch (createError) {
                console.error(createError);
                showNotification("Could not create account. Password too short?", "error");
            }
        } else {
            console.error(error);
            showNotification("Login failed. Check password.", "error");
        }
    }
    setLoading(false);
  };

  const handleLogout = () => {
      signOut(auth);
      window.location.reload();
  };

  const handleGiveDonut = async (recipientName, message) => {
    if (!myProfile) return;
    
    const today = new Date().toDateString();
    let currentGiven = myProfile.last_given_date === today ? myProfile.given_today : 0;

    if (currentGiven >= DAILY_LIMIT) {
      showNotification(`You've used all ${DAILY_LIMIT} ${EMOJI} for today!`, "error");
      return;
    }

    try {
        triggerConfetti(); 

        await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'transactions'), {
            fromName: myProfile.name,
            toName: recipientName,
            message: message,
            timestamp: serverTimestamp(),
            emoji: EMOJI,
            likes: []
        });

        const senderPrivateRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'profile', 'data');
        await updateDoc(senderPrivateRef, {
            given_today: currentGiven + 1,
            last_given_date: today
        });

        const senderPublicRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', myProfile.name);
        const senderPublicDoc = await getDoc(senderPublicRef);
        if (senderPublicDoc.exists()) {
             await updateDoc(senderPublicRef, {
                lifetime_given: (senderPublicDoc.data().lifetime_given || 0) + 1
             });
        }

        const recipientRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', recipientName);
        const recipientDoc = await getDoc(recipientRef);
        
        if (recipientDoc.exists()) {
            await updateDoc(recipientRef, {
                balance: (recipientDoc.data().balance || 0) + 1
            });
        } else {
            await setDoc(recipientRef, {
                name: recipientName,
                balance: 1,
                lifetime_given: 0,
                avatar_color: `hsl(${Math.random() * 360}, 60%, 80%)`,
                claimed: false
            });
        }

        showNotification(`Sent a ${EMOJI} successfully!`);
        setView('feed');

    } catch (e) {
        console.error(e);
        showNotification("Failed to send donut. Try again.", "error");
    }
  };

  const handleReaction = async (txId, currentLikes) => {
      if (currentLikes && currentLikes.includes(myProfile.name)) return;
      const txRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'transactions', txId);
      await updateDoc(txRef, {
          likes: arrayUnion(myProfile.name)
      });
  };

  const handleContributeToGoal = async () => {
      if (!myProfile || myProfile.balance < 1) {
          showNotification("You don't have enough donuts to contribute!", "error");
          return;
      }

      try {
          const publicUserRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', myProfile.name);
          const goalRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'goals', 'frosted-friday');

          await runTransaction(db, async (transaction) => {
              const userDoc = await transaction.get(publicUserRef);
              const goalDoc = await transaction.get(goalRef);

              if (!userDoc.exists()) throw "User does not exist!";
              
              const newBalance = (userDoc.data().balance || 0) - 1;
              if (newBalance < 0) throw "Not enough donuts!";

              const goalCurrent = (goalDoc.data()?.current || 0) + 1;
              
              transaction.update(publicUserRef, { balance: newBalance });
              transaction.update(goalRef, { current: goalCurrent });
              
              const txRef = doc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'transactions'));
              transaction.set(txRef, {
                  fromName: myProfile.name,
                  toName: "Frosted Friday",
                  message: "Contributed to the goal!",
                  timestamp: serverTimestamp(),
                  emoji: "ðŸš€",
                  likes: []
              });
          });
          
          const privateUserRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'profile', 'data');
          await updateDoc(privateUserRef, {
              balance: myProfile.balance - 1
          });

          showNotification("Contributed 1 donut to Frosted Friday!");
          triggerConfetti();

      } catch (e) {
          console.error(e);
          showNotification("Contribution failed.", "error");
      }
  };

  const handleActivateFrostedFriday = async () => {
      try {
          const goalRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'goals', 'frosted-friday');
          await updateDoc(goalRef, { current: 0 });
          
          await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'transactions'), {
              fromName: "Mr Rayner",
              toName: "EVERYONE",
              message: "ðŸš¨ FROSTED FRIDAY IS ON! The goal was met! ðŸ©ðŸŽ‰",
              timestamp: serverTimestamp(),
              emoji: "ðŸš¨",
              likes: []
          });

          showNotification("Frosted Friday Activated! Goal reset.");
          triggerConfetti();
          setView('feed');

      } catch (e) {
          console.error(e);
          showNotification("Failed to activate.", "error");
      }
  };

  const handlePurchase = async (item) => {
      if (!myProfile || myProfile.balance < item.cost) {
          showNotification("Not enough donuts!", "error");
          return;
      }

      const currentUserPublic = users.find(u => u.name === myProfile.name);
      if (item.type === 'digital' && item.id === 'rainbow_name' && currentUserPublic?.rainbow_name) {
          showNotification("You already own this!", "error");
          return;
      }

      try {
          const publicUserRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', myProfile.name);
          
          await runTransaction(db, async (transaction) => {
              const userDoc = await transaction.get(publicUserRef);
              if (!userDoc.exists()) throw "User missing";

              const currentBal = userDoc.data().balance || 0;
              if (currentBal < item.cost) throw "Not enough funds";

              // Deduct cost
              const updates = { balance: currentBal - item.cost };
              
              // Apply Digital Effect immediately
              if (item.type === 'digital' && item.id === 'rainbow_name') {
                  updates.rainbow_name = true;
              }

              transaction.update(publicUserRef, updates);

              // Log transaction (This alerts Mr Rayner for physical items)
              const txRef = doc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'transactions'));
              transaction.set(txRef, {
                  fromName: myProfile.name,
                  toName: "The Shop",
                  message: `Purchased: ${item.name}`,
                  timestamp: serverTimestamp(),
                  emoji: "ðŸ›ï¸",
                  likes: []
              });
          });

          // Update private balance for local state
          const privateUserRef = doc(db, 'artifacts', APP_ID, 'users', user.uid, 'profile', 'data');
          await updateDoc(privateUserRef, {
              balance: myProfile.balance - item.cost
          });

          showNotification(`Bought ${item.name}!`);
          triggerConfetti();

      } catch (e) {
          console.error(e);
          showNotification("Purchase failed.", "error");
      }
  };

  // --- Bounty Actions ---

  const handleCreateBounty = async (title, reward) => {
      await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'bounties'), {
          title,
          reward: parseInt(reward),
          status: 'open',
          createdBy: myProfile.name,
          createdAt: serverTimestamp()
      });
      await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'transactions'), {
          fromName: "Job Board",
          toName: "EVERYONE",
          message: `ðŸ“¢ New Job Posted: ${title} (${reward} ${EMOJI})`,
          timestamp: serverTimestamp(),
          emoji: "ðŸ“¢",
          likes: []
      });
      showNotification("Job Posted & Announced!");
  };

  const handleClaimBounty = async (bountyId) => {
      // OPTION 2: Active Limit Check
      const hasActive = bounties.some(b => b.status === 'claimed' && b.claimantId === user.uid);
      if (hasActive) {
           showNotification("Finish your current job first!", "error");
           return;
      }

      const bountyRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'bounties', bountyId);
      await updateDoc(bountyRef, {
          status: 'claimed',
          claimantName: myProfile.name,
          claimantId: user.uid
      });
      showNotification("Job Claimed! Good luck.");
  };

  const handleUnclaimBounty = async (bountyId) => {
      const bountyRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'bounties', bountyId);
      await updateDoc(bountyRef, {
          status: 'open',
          claimantName: null,
          claimantId: null
      });
      showNotification("Job is open again.");
  };

  const handlePayBounty = async (bountyId, claimantName, reward) => {
      try {
          const recipientRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'users', claimantName);
          const recipientDoc = await getDoc(recipientRef);
          
          if (recipientDoc.exists()) {
              await updateDoc(recipientRef, {
                  balance: (recipientDoc.data().balance || 0) + reward
              });
          }

          const bountyRef = doc(db, 'artifacts', APP_ID, 'public', 'data', 'bounties', bountyId);
          await updateDoc(bountyRef, { status: 'paid' });

          await addDoc(collection(db, 'artifacts', APP_ID, 'public', 'data', 'transactions'), {
              fromName: "Mr Rayner",
              toName: claimantName,
              message: `Completed the bounty: ${reward} Donuts awarded!`,
              timestamp: serverTimestamp(),
              emoji: "ðŸ’°",
              likes: []
          });

          triggerConfetti();
          showNotification("Bounty Paid!");

      } catch (e) {
          console.error(e);
          showNotification("Payment failed", "error");
      }
  };

  const showNotification = (msg, type = "success") => {
    setNotification({ msg, type });
    setTimeout(() => setNotification(null), 3000);
  };

  // --- Render Helpers ---

  if (loading) return (
    <div className="flex items-center justify-center min-h-screen bg-pink-50">
      <div className="animate-spin text-4xl">{EMOJI}</div>
    </div>
  );

  if (!user || !myProfile) {
    return <LoginScreen onLogin={handleLoginOrRegister} existingUsers={users} />;
  }

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 pb-20 md:pb-0">
      <div className="bg-white border-b border-slate-200 sticky top-0 z-10 px-4 py-3 flex justify-between items-center shadow-sm">
        <div className="flex items-center gap-2">
            <div className="bg-pink-100 p-2 rounded-lg">
                <span className="text-xl leading-none">{EMOJI}</span>
            </div>
            <div>
                <h1 className="font-bold text-lg text-slate-900 leading-tight">YumDonut</h1>
                <p className="text-xs text-slate-500">Berkley TV Recognition</p>
            </div>
        </div>
        
        <div className="flex items-center gap-3">
             <div className="hidden md:block text-right">
                <p className="text-sm font-semibold">{myProfile.name}</p>
                <p className="text-xs text-slate-500">
                    {DAILY_LIMIT - (myProfile.last_given_date === new Date().toDateString() ? myProfile.given_today : 0)} left to give
                </p>
             </div>
             <div 
                className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm shadow-inner cursor-pointer hover:opacity-80 transition-opacity"
                style={{ backgroundColor: myProfile.avatar_color }}
                title="Click to Logout"
                onClick={handleLogout}
             >
                {myProfile.name.charAt(0).toUpperCase()}
             </div>
        </div>
      </div>

      <div className="max-w-3xl mx-auto p-4 md:p-6 space-y-6">
        
        {notification && (
            <div className={`fixed top-4 left-1/2 -translate-x-1/2 px-6 py-3 rounded-full shadow-xl z-50 animate-bounce ${
                notification.type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
            }`}>
                {notification.msg}
            </div>
        )}

        <div className="flex overflow-x-auto space-x-2 border-b border-slate-200 mb-4 pb-1">
             {['give', 'jobs', 'shop', 'goal', 'feed', 'leaderboard'].map(tab => (
                 <button
                    key={tab}
                    onClick={() => setView(tab)}
                    className={`px-4 py-2 font-medium text-sm capitalize border-b-2 transition-colors whitespace-nowrap relative ${
                        view === tab ? 'border-pink-500 text-pink-600' : 'border-transparent text-slate-500 hover:text-slate-700'
                    }`}
                 >
                    {tab}
                    {tab === 'jobs' && openBountyCount > 0 && (
                        <span className="absolute -top-1 -right-1 bg-red-500 text-white text-[10px] font-bold px-1.5 py-0.5 rounded-full shadow-sm">
                            {openBountyCount}
                        </span>
                    )}
                 </button>
             ))}
        </div>

        {view === 'give' && (
            <GiveView 
                roster={SCHOOL_ROSTER}
                existingUsers={users}
                currentUserName={myProfile.name}
                onGive={handleGiveDonut} 
                remaining={DAILY_LIMIT - (myProfile.last_given_date === new Date().toDateString() ? myProfile.given_today : 0)}
            />
        )}

        {view === 'jobs' && (
            <BountiesView 
                bounties={bounties}
                currentUser={myProfile}
                userId={user.uid}
                onCreate={handleCreateBounty}
                onClaim={handleClaimBounty}
                onUnclaim={handleUnclaimBounty}
                onPay={handlePayBounty}
            />
        )}

        {view === 'shop' && (
            <ShopView 
                items={SHOP_ITEMS}
                userBalance={myProfile.balance}
                onPurchase={handlePurchase}
                currentUserPublic={users.find(u => u.name === myProfile.name)}
            />
        )}

        {view === 'goal' && (
            <GoalView 
                goalData={goalData} 
                userBalance={myProfile.balance}
                onContribute={handleContributeToGoal}
                currentUserName={myProfile.name}
                onActivate={handleActivateFrostedFriday}
            />
        )}
        
        {view === 'feed' && (
            <FeedView transactions={transactions} onReact={handleReaction} />
        )}
        
        {view === 'leaderboard' && (
            <LeaderboardView users={users} roster={SCHOOL_ROSTER} />
        )}

      </div>

      <div className="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 px-6 py-3 flex justify-between z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <NavBtn icon={Gift} label="Give" active={view === 'give'} onClick={() => setView('give')} />
        <NavBtn icon={Briefcase} label="Jobs" active={view === 'jobs'} onClick={() => setView('jobs')} badge={openBountyCount} />
        <NavBtn icon={ShoppingBag} label="Shop" active={view === 'shop'} onClick={() => setView('shop')} />
        <NavBtn icon={Activity} label="Feed" active={view === 'feed'} onClick={() => setView('feed')} />
      </div>
    </div>
  );
}

// --- Sub-Components ---

function LoginScreen({ onLogin, existingUsers }) {
  const [search, setSearch] = useState("");
  const [selectedName, setSelectedName] = useState(null);
  const [password, setPassword] = useState("");

  const availableNames = SCHOOL_ROSTER.filter(name => {
    return name.toLowerCase().includes(search.toLowerCase());
  });

  // Helper to check status
  const isClaimed = (name) => {
      const user = existingUsers.find(u => u.name === name);
      return user && user.claimed;
  };

  const handleLogin = () => {
      if (selectedName && password) {
          onLogin(selectedName, password);
      }
  };

  return (
    <div className="min-h-screen flex flex-col items-center justify-center bg-slate-50 p-4">
      <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center border-t-8 border-pink-500">
        <div className="text-6xl mb-4">{EMOJI}</div>
        <h1 className="text-2xl font-bold mb-2 text-slate-800">Welcome to YumDonut</h1>
        <p className="text-slate-500 mb-6">Select your name to get started.</p>
        
        {!selectedName ? (
            <div className="space-y-4 text-left">
                <div className="relative">
                    <Search className="absolute left-3 top-3 text-slate-400" size={20} />
                    <input 
                    type="text" 
                    className="w-full pl-10 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none transition"
                    placeholder="Search your name..."
                    value={search}
                    onChange={(e) => setSearch(e.target.value)}
                    />
                </div>

                <div className="h-48 overflow-y-auto border border-slate-100 rounded-lg bg-slate-50 p-2 space-y-1">
                    {availableNames.length === 0 ? (
                        <div className="text-center text-slate-400 py-4 text-sm">No names found.</div>
                    ) : (
                        availableNames.map(name => {
                            const claimed = isClaimed(name);
                            return (
                                <button
                                    key={name}
                                    onClick={() => setSelectedName(name)}
                                    className="w-full text-left px-4 py-2 rounded-md text-sm font-medium hover:bg-white hover:shadow-sm text-slate-600 transition-all flex justify-between items-center"
                                >
                                    <span>{name}</span>
                                    {/* Removed Login/Register badges since we can't check without login */}
                                </button>
                            );
                        })
                    )}
                </div>
            </div>
        ) : (
            <div className="space-y-4 text-left animate-in fade-in slide-in-from-right-4">
                <div className="flex items-center justify-between bg-pink-50 p-3 rounded-lg">
                    <div className="flex items-center gap-2">
                        <span className="font-bold text-pink-700">{selectedName}</span>
                    </div>
                    <button onClick={() => { setSelectedName(null); setPassword(""); }} className="text-xs text-pink-400 hover:text-pink-600">Change</button>
                </div>
                <div>
                    <label className="block text-xs font-bold text-slate-500 mb-1 uppercase">
                        Password
                    </label>
                    <div className="relative">
                        <Lock className="absolute left-3 top-3 text-slate-400" size={18} />
                        <input 
                            type="password" 
                            className="w-full pl-10 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-pink-500 outline-none"
                            placeholder="Enter password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            onKeyDown={(e) => e.key === 'Enter' && handleLogin()}
                        />
                    </div>
                    <p className="text-xs text-slate-400 mt-1">First time? Create a password. Returning? Login.</p>
                </div>
                <Button variant="primary" className="w-full py-3 text-lg" onClick={handleLogin} disabled={!password}>
                    Continue
                </Button>
            </div>
        )}
      </div>
    </div>
  );
}

function ShopView({ items, userBalance, onPurchase, currentUserPublic }) {
    return (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <Card className="bg-gradient-to-r from-purple-500 to-pink-500 text-white">
                <h2 className="text-2xl font-bold flex items-center gap-2">
                    <ShoppingBag /> The Donut Shop
                </h2>
                <p className="opacity-90">Spend your hard-earned donuts on rewards!</p>
                <div className="mt-4 text-sm font-bold bg-white/20 inline-block px-3 py-1 rounded-full">
                    Your Balance: {userBalance} {EMOJI}
                </div>
            </Card>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                {items.map(item => {
                    const canAfford = userBalance >= item.cost;
                    const isOwned = item.type === 'digital' && item.id === 'rainbow_name' && currentUserPublic?.rainbow_name;

                    return (
                        <Card key={item.id} className="flex flex-col justify-between relative overflow-hidden border-2 border-slate-100 hover:border-pink-200 transition-colors">
                            {isOwned && <div className="absolute top-2 right-2 text-green-500"><CheckCircle /></div>}
                            <div>
                                <div className="text-4xl mb-2">{item.icon}</div>
                                <h3 className="font-bold text-lg text-slate-800">{item.name}</h3>
                                <p className="text-sm text-slate-500 mb-4">{item.desc}</p>
                            </div>
                            
                            <div className="flex justify-between items-center mt-2">
                                <span className="font-bold text-pink-600">{item.cost} {EMOJI}</span>
                                <Button 
                                    onClick={() => onPurchase(item)} 
                                    disabled={!canAfford || isOwned}
                                    className={!canAfford ? "opacity-50" : ""}
                                >
                                    {isOwned ? "Owned" : "Buy"}
                                </Button>
                            </div>
                        </Card>
                    );
                })}
            </div>
        </div>
    );
}

function BountiesView({ bounties, currentUser, userId, onCreate, onClaim, onUnclaim, onPay }) {
    const [newTitle, setNewTitle] = useState("");
    const [newReward, setNewReward] = useState(5);
    const isAdmin = currentUser.name === "Mr Rayner";

    const activeBounties = bounties.filter(b => b.status !== 'paid');

    return (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            {isAdmin && (
                <Card className="bg-pink-50 border-pink-100">
                    <h3 className="font-bold text-pink-700 mb-3 flex items-center gap-2">
                        <Briefcase size={20}/> Post New Job
                    </h3>
                    <div className="flex gap-2 flex-col md:flex-row">
                        <input 
                            className="flex-grow p-2 rounded-lg border border-pink-200"
                            placeholder="Job Description (e.g. Film Assembly)"
                            value={newTitle}
                            onChange={e => setNewTitle(e.target.value)}
                        />
                        <div className="flex gap-2">
                            <input 
                                type="number"
                                className="w-20 p-2 rounded-lg border border-pink-200"
                                value={newReward}
                                onChange={e => setNewReward(e.target.value)}
                            />
                            <Button onClick={() => { onCreate(newTitle, newReward); setNewTitle(""); }}>
                                Post
                            </Button>
                        </div>
                    </div>
                </Card>
            )}

            <div className="space-y-3">
                <h3 className="font-bold text-slate-700 ml-1 flex justify-between items-center">
                    <span>Active Jobs</span>
                    <span className="text-xs font-normal text-slate-400">Latest first</span>
                </h3>
                {activeBounties.length === 0 && <div className="text-center text-slate-400 py-8">No active jobs right now.</div>}
                
                {activeBounties.map(b => {
                    const isMyClaim = b.claimantId === userId;

                    // --- CHECK: Does the user have ANY other job claimed? ---
                    // bounties prop contains all bounties.
                    // We check if there exists ANY bounty that is 'claimed' AND claimantId matches user.
                    const hasActiveJob = bounties.some(job => job.status === 'claimed' && job.claimantId === userId);

                    return (
                        <Card key={b.id} className="flex justify-between items-center border-l-4 border-l-pink-500">
                            <div className="flex-grow min-w-0 mr-2">
                                <h4 className="font-bold text-slate-800 break-words">{b.title}</h4>
                                <div className="flex items-center gap-2 mt-1 flex-wrap">
                                    <span className="bg-pink-100 text-pink-700 px-2 py-0.5 rounded-full text-xs font-bold whitespace-nowrap">
                                        {b.reward} {EMOJI} Reward
                                    </span>
                                    {b.status === 'claimed' && (
                                        <span className="text-xs text-slate-500 flex items-center gap-1 whitespace-nowrap">
                                            <CheckSquare size={12}/> Claimed by {b.claimantName}
                                        </span>
                                    )}
                                </div>
                            </div>
                            
                            <div className="flex gap-2 flex-shrink-0">
                                {/* OPEN Status - Smart Button */}
                                {b.status === 'open' && (
                                    <Button 
                                        variant="outline" 
                                        onClick={() => onClaim(b.id)}
                                        disabled={hasActiveJob} // Gray out if they have work
                                        className={hasActiveJob ? "opacity-50 cursor-not-allowed" : ""}
                                        title={hasActiveJob ? "Finish your current job first!" : "Claim this job"}
                                    >
                                        Claim
                                    </Button>
                                )}

                                {b.status === 'claimed' && isAdmin && (
                                    <>
                                        <button 
                                            onClick={() => onUnclaim(b.id)}
                                            className="p-2 text-red-400 hover:text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                            title="Revoke Claim"
                                        >
                                            <XCircle size={20} />
                                        </button>
                                        <Button variant="success" onClick={() => onPay(b.id, b.claimantName, b.reward)} className="whitespace-nowrap">
                                            Pay & Close
                                        </Button>
                                    </>
                                )}

                                {b.status === 'claimed' && isMyClaim && !isAdmin && (
                                    <Button variant="danger" onClick={() => onUnclaim(b.id)} className="text-xs px-2 whitespace-nowrap">
                                        Cancel Claim
                                    </Button>
                                )}

                                {b.status === 'claimed' && !isMyClaim && !isAdmin && (
                                    <span className="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500 self-center whitespace-nowrap">
                                        Busy
                                    </span>
                                )}
                            </div>
                        </Card>
                    );
                })}
            </div>
        </div>
    );
}

function GoalView({ goalData, userBalance, onContribute, currentUserName, onActivate }) {
    const percent = Math.min(100, ((goalData.current || 0) / GOAL_TARGET) * 100);
    const isMet = (goalData.current || 0) >= GOAL_TARGET;
    const isAdmin = currentUserName === "Mr Rayner";

    return (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
             <Card className="text-center py-8 relative overflow-hidden">
                {isMet && <div className="absolute inset-0 bg-yellow-100 opacity-20 animate-pulse"></div>}
                <div className="relative z-10">
                    <div className="inline-flex items-center justify-center p-3 bg-pink-100 rounded-full text-pink-500 mb-4">
                        <Sparkles size={32} />
                    </div>
                    <h2 className="text-2xl font-bold text-slate-800 mb-2">Frosted Friday Goal</h2>
                    <p className="text-slate-500 mb-6 max-w-md mx-auto">
                        If we reach {GOAL_TARGET} donuts together, we unlock donuts for everyone!
                    </p>

                    <div className="max-w-lg mx-auto bg-slate-100 rounded-full h-8 mb-2 relative">
                        <div 
                            className="bg-gradient-to-r from-pink-500 to-purple-500 h-full rounded-full transition-all duration-1000 ease-out flex items-center justify-end pr-2"
                            style={{ width: `${percent}%` }}
                        >
                            <span className="text-white text-xs font-bold drop-shadow-md">{Math.floor(percent)}%</span>
                        </div>
                    </div>
                    <p className="text-sm font-bold text-slate-700 mb-8">
                        {goalData.current} / {GOAL_TARGET} {EMOJI} raised
                    </p>

                    {isMet ? (
                        <div className="space-y-4">
                            <div className="bg-green-100 text-green-700 p-4 rounded-xl font-bold text-lg animate-bounce">
                                ðŸŽ‰ GOAL REACHED! ({goalData.current}/{GOAL_TARGET})
                            </div>
                            {isAdmin ? (
                                <Button 
                                    onClick={onActivate} 
                                    variant="success"
                                    className="w-full py-3 text-lg"
                                >
                                    ðŸš¨ Activate Frosted Friday! ðŸš¨
                                </Button>
                            ) : (
                                <p className="text-sm text-slate-500 italic">Waiting for Mr Rayner to activate the event...</p>
                            )}
                        </div>
                    ) : (
                        <div className="flex flex-col items-center gap-2">
                             <Button 
                                onClick={onContribute} 
                                variant="primary"
                                className="w-full max-w-xs py-3 text-lg"
                            >
                                Contribute 1 {EMOJI}
                            </Button>
                            <p className="text-xs text-slate-400">
                                You have {userBalance} donuts available.
                            </p>
                        </div>
                    )}
                </div>
             </Card>
        </div>
    );
}

// ... LoginScreen, GiveView, FeedView, LeaderboardView, NavBtn ...
function GiveView({ roster, existingUsers, currentUserName, onGive, remaining }) {
    const [selectedUser, setSelectedUser] = useState("");
    const [message, setMessage] = useState("");
    const [filter, setFilter] = useState("");

    const filteredRoster = roster
        .filter(name => name !== currentUserName)
        .filter(name => name.toLowerCase().includes(filter.toLowerCase()));

    const handleSubmit = () => {
        if (!selectedUser || !message) return;
        onGive(selectedUser, message);
        setMessage("");
        setSelectedUser("");
        setFilter("");
    };

    return (
        <div className="space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500">
            <div className="md:hidden bg-pink-500 text-white p-6 rounded-2xl shadow-lg shadow-pink-200 flex justify-between items-center">
                <div>
                    <h2 className="font-bold text-lg opacity-90">Daily Balance</h2>
                    <p className="text-xs opacity-75">Use them or lose them!</p>
                </div>
                <div className="text-4xl font-black">{remaining}</div>
            </div>

            <Card className="space-y-4">
                <div className="flex items-center gap-2 mb-2">
                    <Heart className="text-pink-500" size={24} />
                    <h2 className="text-xl font-bold text-slate-800">Who deserves a donut?</h2>
                </div>

                {remaining === 0 ? (
                     <div className="bg-slate-100 p-6 rounded-xl text-center text-slate-500">
                        <p className="text-lg font-medium">You're all out of donuts!</p>
                        <p className="text-sm">Come back tomorrow for a fresh batch.</p>
                     </div>
                ) : (
                    <>
                        <div className="space-y-2">
                            <label className="text-sm font-semibold text-slate-600">Select Teammate</label>
                            {!selectedUser ? (
                                <div className="relative">
                                    <input 
                                        className="w-full p-3 pl-10 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-pink-500 outline-none"
                                        placeholder="Search name..."
                                        value={filter}
                                        onChange={e => setFilter(e.target.value)}
                                    />
                                    <UserPlus className="absolute left-3 top-3.5 text-slate-400" size={18} />
                                    
                                    {filter && (
                                        <div className="absolute top-full left-0 right-0 mt-1 bg-white shadow-xl rounded-xl border border-slate-100 max-h-60 overflow-y-auto z-10 divide-y divide-slate-50">
                                            {filteredRoster.map(name => {
                                                const userData = existingUsers.find(u => u.name === name);
                                                const bgColor = userData?.avatar_color || "#cbd5e1"; 
                                                
                                                return (
                                                    <button 
                                                        key={name}
                                                        onClick={() => { setSelectedUser(name); setFilter(""); }}
                                                        className="w-full text-left p-3 hover:bg-pink-50 flex items-center gap-3 transition-colors"
                                                    >
                                                        <div className="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold" style={{background: bgColor}}>
                                                            {name[0]}
                                                        </div>
                                                        <span>{name}</span>
                                                    </button>
                                                )
                                            })}
                                            {filteredRoster.length === 0 && <div className="p-3 text-slate-400 text-sm">No users found</div>}
                                        </div>
                                    )}
                                </div>
                            ) : (
                                <div className="flex items-center justify-between p-3 bg-pink-50 border border-pink-200 rounded-xl">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold" 
                                             style={{background: existingUsers.find(u => u.name === selectedUser)?.avatar_color || "#cbd5e1"}}>
                                            {selectedUser[0]}
                                        </div>
                                        <span className="font-medium text-slate-800">
                                            {selectedUser}
                                        </span>
                                    </div>
                                    <button onClick={() => setSelectedUser("")} className="text-slate-400 hover:text-red-500">
                                        <LogOut size={18} />
                                    </button>
                                </div>
                            )}
                        </div>

                        <div className="space-y-2">
                            <label className="text-sm font-semibold text-slate-600">Reason</label>
                            <textarea 
                                className="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-pink-500 outline-none resize-none"
                                rows={3}
                                placeholder="Thanks for helping me with the filming!"
                                value={message}
                                onChange={e => setMessage(e.target.value)}
                            />
                        </div>

                        <Button 
                            onClick={handleSubmit} 
                            disabled={!selectedUser || !message}
                            className="w-full py-3 text-lg"
                        >
                            Give {EMOJI} <span className="text-sm opacity-80 ml-1">({remaining} left)</span>
                        </Button>
                    </>
                )}
            </Card>
        </div>
    );
}

function FeedView({ transactions, onReact }) {
    return (
        <div className="space-y-4 animate-in fade-in duration-500">
            <h2 className="text-xl font-bold text-slate-800 px-1">Recent Activity</h2>
            {transactions.length === 0 ? (
                <div className="text-center py-10 text-slate-400">
                    <p className="text-4xl mb-2">ðŸ¦—</p>
                    <p>No donuts given yet. Be the first!</p>
                </div>
            ) : (
                transactions.map(tx => (
                    <Card key={tx.id} className="flex gap-4 relative">
                        <div className="flex-shrink-0 mt-1 bg-pink-100 text-pink-500 p-2 rounded-full h-10 w-10 flex items-center justify-center text-lg shadow-sm">
                            {tx.emoji || EMOJI}
                        </div>
                        <div className="flex-grow pb-6">
                            <div className="flex flex-wrap items-baseline gap-x-1 mb-1">
                                <span className="font-bold text-slate-900">{tx.fromName}</span>
                                {tx.toName === "Frosted Friday" || tx.toName === "EVERYONE" || tx.toName === "The Shop" || tx.fromName === "Job Board" ? (
                                    <span className="text-slate-500 text-sm ml-1">
                                        {tx.message.includes("activated") ? "announced" : 
                                         tx.message.includes("Purchased") ? "went shopping" : 
                                         tx.emoji === "ðŸ“¢" ? "announced" : "contributed to"}
                                    </span>
                                ) : (
                                    <>
                                        <span className="text-slate-500 text-sm mx-1">gave a donut to</span>
                                        <span className="font-bold text-slate-900">{tx.toName}</span>
                                    </>
                                )}
                            </div>
                            <p className="text-slate-700 bg-slate-50 p-2 rounded-lg border border-slate-100 italic text-sm">
                                "{tx.message}"
                            </p>
                            <p className="text-xs text-slate-400 mt-2 text-right">
                                {tx.timestamp ? new Date(tx.timestamp.toDate()).toLocaleString() : 'Just now'}
                            </p>
                            
                            <button 
                                onClick={() => onReact(tx.id, tx.likes)}
                                className="absolute bottom-3 left-16 text-xs bg-slate-50 hover:bg-orange-50 border border-slate-200 px-2 py-1 rounded-full flex items-center gap-1 transition-colors"
                            >
                                <Flame size={12} className={tx.likes?.length ? "text-orange-500 fill-orange-500" : "text-slate-400"} />
                                <span className={tx.likes?.length ? "text-orange-600 font-bold" : "text-slate-500"}>
                                    {tx.likes?.length || 0}
                                </span>
                            </button>
                        </div>
                    </Card>
                ))
            )}
        </div>
    );
}

function LeaderboardView({ users, roster }) {
    const combinedList = roster.map(name => {
        const userData = users.find(u => u.name === name);
        return {
            name: name,
            balance: userData ? userData.balance : 0,
            avatar_color: userData ? userData.avatar_color : '#cbd5e1',
            rainbow_name: userData ? userData.rainbow_name : false
        };
    }).sort((a, b) => b.balance - a.balance);

    return (
        <div className="space-y-4 animate-in fade-in duration-500">
            <div className="flex justify-between items-end px-1">
                <h2 className="text-xl font-bold text-slate-800">Leaderboard</h2>
                <span className="text-xs font-medium bg-pink-100 text-pink-600 px-2 py-1 rounded-full">All Time</span>
            </div>

            <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                {combinedList.map((u, index) => (
                    <div key={u.name} className="flex items-center p-4 border-b border-slate-50 hover:bg-slate-50 transition-colors last:border-none">
                        <div className="w-8 font-bold text-slate-400 text-center flex-shrink-0">
                            {index === 0 ? 'ðŸ¥‡' : index === 1 ? 'ðŸ¥ˆ' : index === 2 ? 'ðŸ¥‰' : index + 1}
                        </div>
                        <div className="mx-4">
                            <div className="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold shadow-sm" style={{background: u.avatar_color}}>
                                {u.name[0]}
                            </div>
                        </div>
                        <div className="flex-grow min-w-0">
                            <p className={`font-bold truncate ${u.rainbow_name ? 'animate-text-rainbow bg-clip-text text-transparent bg-gradient-to-r from-purple-400 via-pink-500 to-red-500' : 'text-slate-800'}`}>
                                {u.name}
                            </p>
                            <p className="text-xs text-slate-500">{u.balance} donuts received</p>
                        </div>
                        <div className="text-right pl-2">
                             <div className="inline-flex items-center bg-pink-50 text-pink-600 px-3 py-1 rounded-full font-bold text-sm">
                                {u.balance} {EMOJI}
                             </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}

const NavBtn = ({ icon: Icon, label, active, onClick, badge }) => (
    <button 
        onClick={onClick}
        className={`flex flex-col items-center gap-1 w-16 transition-colors relative ${active ? 'text-pink-500' : 'text-slate-400 hover:text-slate-600'}`}
    >
        <div className="relative">
            <Icon size={24} strokeWidth={active ? 2.5 : 2} />
            {badge > 0 && (
                <span className="absolute -top-2 -right-2 bg-red-500 text-white text-[10px] font-bold h-4 w-4 flex items-center justify-center rounded-full shadow-sm">
                    {badge}
                </span>
            )}
        </div>
        <span className="text-[10px] font-medium">{label}</span>
    </button>
);